name: GitHub-Profile-3D-Contrib

on:
  schedule:
    - cron: "0 */4 * * *"  # Every 4 hours
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    name: generate-github-profile-3d-contrib
    steps:
      - uses: actions/checkout@v5
      - uses: yoshi389111/github-profile-3d-contrib@latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          USERNAME: ${{ github.repository_owner }}
          YEAR: "2026"
          SETTING_JSON: cheese-settings.json
      - name: Fetch streak count
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get contributions and calculate streak with Python
          echo "Fetching contributions for ${{ github.repository_owner }}..."
          
          gh api graphql -f query='
            query($user: String!) {
              user(login: $user) {
                contributionsCollection {
                  contributionCalendar {
                    weeks {
                      contributionDays {
                        contributionCount
                        date
                      }
                    }
                  }
                }
              }
            }
          ' -f user="${{ github.repository_owner }}" > /tmp/contrib.json
          
          STREAK=$(python3 << 'EOF'
          import json
          from datetime import datetime, timedelta
          
          with open('/tmp/contrib.json') as f:
              data = json.load(f)
          
          # Build a dict for easy lookup
          contrib = {}
          for week in data['data']['user']['contributionsCollection']['contributionCalendar']['weeks']:
              for day in week['contributionDays']:
                  contrib[day['date']] = day['contributionCount']
          
          today = datetime.utcnow().date()
          
          # Start from today if there are contributions, otherwise yesterday
          start_date = today
          if contrib.get(str(today), 0) == 0:
              start_date = today - timedelta(days=1)
          
          # Count consecutive days with contributions
          streak = 0
          check_date = start_date
          
          while True:
              date_str = check_date.strftime('%Y-%m-%d')
              if contrib.get(date_str, 0) > 0:
                  streak += 1
                  check_date -= timedelta(days=1)
              else:
                  break
          
          print(streak)
          EOF
          )
          
          echo "STREAK_COUNT=$STREAK" >> $GITHUB_ENV
          echo "Calculated streak: $STREAK"
      - name: Process SVG (strip extras, add streak)
        run: python strip-svg.py profile-3d-contrib/profile-cheese.svg --streak ${{ env.STREAK_COUNT }}
      - name: Commit & Push
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add -A .
          if git commit -m "generated"; then
            git push
          fi
