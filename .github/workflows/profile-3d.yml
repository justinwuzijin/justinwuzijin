name: GitHub-Profile-3D-Contrib

on:
  schedule:
    - cron: "0 */4 * * *"  # Every 4 hours
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    name: generate-github-profile-3d-contrib
    steps:
      - uses: actions/checkout@v5
      - uses: yoshi389111/github-profile-3d-contrib@latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          USERNAME: ${{ github.repository_owner }}
          YEAR: "2026"
          SETTING_JSON: cheese-settings.json
      - name: Fetch streak count
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get contributions and calculate streak with Python
          echo "Fetching contributions for ${{ github.repository_owner }}..."
          
          gh api graphql -f query='
            query($user: String!) {
              user(login: $user) {
                contributionsCollection {
                  contributionCalendar {
                    weeks {
                      contributionDays {
                        contributionCount
                        date
                      }
                    }
                  }
                }
              }
            }
          ' -f user="${{ github.repository_owner }}" > /tmp/contrib.json
          
          STREAK=$(python3 << 'EOF'
          import json
          from datetime import datetime, timedelta
          
          with open('/tmp/contrib.json') as f:
              data = json.load(f)
          
          days = []
          for week in data['data']['user']['contributionsCollection']['contributionCalendar']['weeks']:
              for day in week['contributionDays']:
                  days.append((day['date'], day['contributionCount']))
          
          days.sort(key=lambda x: x[0], reverse=True)
          
          # Count streak from today backwards
          streak = 0
          today = datetime.utcnow().date()
          
          for date_str, count in days:
              date = datetime.strptime(date_str, '%Y-%m-%d').date()
              expected = today - timedelta(days=streak)
              
              if date == expected and count > 0:
                  streak += 1
              elif date == expected and count == 0:
                  # Today has no contributions yet, check from yesterday
                  if streak == 0:
                      continue
                  else:
                      break
              elif date < expected:
                  break
          
          print(streak)
          EOF
          )
          
          echo "STREAK_COUNT=$STREAK" >> $GITHUB_ENV
          echo "Calculated streak: $STREAK"
      - name: Process SVG (strip extras, add streak)
        run: python strip-svg.py profile-3d-contrib/profile-cheese.svg --streak ${{ env.STREAK_COUNT }}
      - name: Commit & Push
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add -A .
          if git commit -m "generated"; then
            git push
          fi
